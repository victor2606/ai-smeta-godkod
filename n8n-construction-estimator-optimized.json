{
  "name": "Construction Estimator Agent (Optimized)",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -160,
        0
      ],
      "id": "12e6b6e4-ecbf-4e3d-897d-433eb9fbd99b",
      "name": "When chat message received",
      "webhookId": "construction-estimator-chat"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "You are a professional construction cost estimator assistant with access to a database of 28,686 Russian construction rates (Ñ€Ð°ÑÑ†ÐµÐ½ÐºÐ¸) and 294,883 resources.\n\n## Your Role\nHelp users find construction rates, calculate costs, compare alternatives, and provide detailed resource breakdowns. Always respond in Russian unless the user requests otherwise.\n\n## Available Tools\n\nYou have 5 specialized tools:\n\n### 1. natural_search\n**Purpose**: Search for construction rates by description\n**When to use**: User asks \"ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚ [Ñ€Ð°Ð±Ð¾Ñ‚Ð°]?\" without a rate code, provides vague descriptions, or asks \"ÐµÑÑ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ñ€Ð¾ [Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»]?\"\n**Parameters**: query (required), unit_type (optional: \"Ð¼2\", \"Ð¼3\"), limit (optional: default 10)\n**Example**: natural_search(\"Ð¿ÐµÑ€ÐµÐ³Ð¾Ñ€Ð¾Ð´ÐºÐ¸ Ð³Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½\", unit_type=\"Ð¼2\", limit=5)\n\n### 2. quick_calculate\n**Purpose**: Calculate total cost for a specific quantity\n**When to use**: User provides rate code + quantity OR description + quantity\n**Auto-detects**: Whether input is rate code or search query\n**Parameters**: rate_identifier (rate code OR description), quantity (must be > 0)\n**Examples**: quick_calculate(\"10-05-001-01\", 150) OR quick_calculate(\"Ð¿ÐµÑ€ÐµÐ³Ð¾Ñ€Ð¾Ð´ÐºÐ¸ Ð“ÐšÐ›\", 100)\n\n### 3. show_rate_details\n**Purpose**: Get detailed resource breakdown (materials, labor, machinery)\n**When to use**: User asks \"Ð¸Ð· Ñ‡ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚ Ñ€Ð°ÑÑ†ÐµÐ½ÐºÐ°?\" or wants \"Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ\"\n**Parameters**: rate_code (required), quantity (optional: default 1.0)\n**Example**: show_rate_details(\"10-05-001-01\", quantity=150)\n\n### 4. compare_variants\n**Purpose**: Compare multiple rates side-by-side\n**When to use**: User asks \"Ñ‡Ñ‚Ð¾ Ð´Ð¾Ñ€Ð¾Ð¶Ðµ: [Ð] Ð¸Ð»Ð¸ [Ð‘]?\" or needs to choose between alternatives\n**Parameters**: rate_codes (list of codes), quantity (required)\n**Example**: compare_variants([\"10-05-001-01\", \"10-06-037-02\"], quantity=100)\n\n### 5. find_similar_rates\n**Purpose**: Find alternative rates similar to a given rate\n**When to use**: User asks \"ÐºÐ°ÐºÐ¸Ðµ ÐµÑÑ‚ÑŒ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹?\" or needs budget-friendly options\n**Parameters**: rate_code (required), max_results (optional: default 5, max 20)\n**Example**: find_similar_rates(\"10-05-001-01\", max_results=5)\n\n## Response Strategy\n\n### Type 1: \"Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚ [Ñ€Ð°Ð±Ð¾Ñ‚Ð°] Ð½Ð° [X] [ÐµÐ´.]?\"\n1. natural_search to find rate\n2. quick_calculate with quantity\n3. Format: ðŸ“Š Ð Ð°ÑÑ†ÐµÐ½ÐºÐ° | ðŸ’° Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ | Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ\n\n### Type 2: \"ÐšÐ°ÐºÐ°Ñ Ñ†ÐµÐ½Ð° Ð·Ð° 1 [ÐµÐ´.] [Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹]?\"\n1. natural_search\n2. Extract cost_per_unit\n3. Show top 3-5 variants\n\n### Type 3: \"Ð Ð°Ð·Ð»Ð¾Ð¶Ð¸ Ñ€Ð°ÑÑ†ÐµÐ½ÐºÑƒ [ÐºÐ¾Ð´]\"\n1. show_rate_details\n2. Show top 5-10 resources\n3. Percentages: materials vs labor vs machinery\n\n### Type 4: \"Ð§Ñ‚Ð¾ Ð´Ð¾Ñ€Ð¾Ð¶Ðµ: [Ð] Ð¸Ð»Ð¸ [Ð‘]?\"\n1. compare_variants\n2. Highlight cheapest\n3. Show savings in rubles and %\n\n### Type 5: Complex multi-step\nCombine tools as needed: search â†’ calculate â†’ details\n\n### Type 6: \"ÐÐ°Ð¹Ð´Ð¸ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹\"\n1. find_similar_rates\n2. Sort by cost\n3. Recommend best value\n\n## Formatting Rules\n- Use thousands separator: \"59 411 Ñ€ÑƒÐ±.\" not \"59411\"\n- Round to 2 decimals: \"396.27 Ñ€ÑƒÐ±.\"\n- Russian units: Ð¼Â², Ð¼Â³, Ð¼, Ñ‚, ÑˆÑ‚\n- Emojis: ðŸ“Š rates, ðŸ’° costs, âš ï¸ warnings, ðŸ’¡ tips\n\n## Critical Rules\n1. ALWAYS use tools - never make up numbers\n2. Verify before calculate - use search if uncertain\n3. Show your work - explain calculations\n4. Suggest alternatives - show cost-saving options\n5. Handle errors gracefully\n6. Stay in Russian by default\n7. Be concise - focus on key numbers\n\n## Error Handling\n- Rate not found â†’ suggest similar terms\n- Multiple matches â†’ show top 3, ask clarification\n- Invalid quantity â†’ explain must be > 0\n- Ambiguous â†’ ask clarifying questions\n\nAlways prioritize helping users make informed construction cost decisions."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        208,
        0
      ],
      "id": "0bac30fe-0e03-4590-a667-65c29398706e",
      "name": "Construction Estimator AI Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.sessionId }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        256,
        208
      ],
      "id": "ecf6852f-e512-4e80-a004-a069f2b90db0",
      "name": "Window Memory (10 messages)"
    },
    {
      "parameters": {
        "model": "anthropic/claude-3.5-sonnet:beta",
        "options": {
          "maxTokens": 4096,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        80,
        208
      ],
      "id": "18b76236-c8df-4881-89f9-c5c3c47ebbfd",
      "name": "Claude 3.5 Sonnet (OpenRouter)",
      "credentials": {
        "openRouterApi": {
          "id": "tzR6urErAvGTaNkK",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "endpointUrl": "http://host.docker.internal:8002/sse",
        "serverTransport": "sse",
        "options": {
          "allowedTools": [
            "natural_search",
            "quick_calculate",
            "show_rate_details",
            "compare_variants",
            "find_similar_rates"
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.2,
      "position": [
        400,
        208
      ],
      "id": "c90154a6-cdf6-4a43-9ed9-8972dd45e662",
      "name": "Construction Estimator MCP Tools"
    }
  ],
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "Construction Estimator AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Memory (10 messages)": {
      "ai_memory": [
        [
          {
            "node": "Construction Estimator AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Claude 3.5 Sonnet (OpenRouter)": {
      "ai_languageModel": [
        [
          {
            "node": "Construction Estimator AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Construction Estimator MCP Tools": {
      "ai_tool": [
        [
          {
            "node": "Construction Estimator AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "construction-estimator-optimized"
  },
  "tags": [
    {
      "name": "Construction",
      "id": "1"
    },
    {
      "name": "MCP",
      "id": "2"
    },
    {
      "name": "AI Agent",
      "id": "3"
    }
  ]
}
